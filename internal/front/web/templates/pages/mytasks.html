{{ define "pages/mytasks.html" }}
<section class="page">
  <div class="page-head">
    <h1>My Tasks</h1>

    {{ if .VM.CanCreate }}
      <button class="btn" type="button" onclick="document.getElementById('createTaskModal').showModal()">
        + Create Task
      </button>
    {{ end }}
  </div>

  <div class="card">
    <p><b>Total assigned:</b> {{ .VM.TotalTasks }}</p>
    <p class="muted">
      TODO: {{ index .VM.StatusCounts "TODO" }} ·
      IN_PROGRESS: {{ index .VM.StatusCounts "IN_PROGRESS" }} ·
      DONE: {{ index .VM.StatusCounts "DONE" }}
    </p>
  </div>

  {{ if .VM.Tasks }}
  <div class="card">
    <table class="table">
      <thead>
        <tr>
          <th>Title</th>
          <th>Status</th>
          <th>Due</th>
          <th>Priority</th>
          <th>Team</th>
          <th class="right">Actions</th>
        </tr>
      </thead>

      <tbody>
        {{ range .VM.Tasks }}
        <tr id="task-row-{{ .TaskID }}">
          <td><b>{{ .Title }}</b></td>

          <td>
            <span id="task-status-{{ .TaskID }}">{{ .Status }}</span>
          </td>

          <td class="muted">
            {{ if .Deadline.IsZero }}-{{ else }}{{ .Deadline.Format "2006-01-02" }}{{ end }}
          </td>

          <td class="muted">{{ .Priority }}</td>

          <td class="muted">{{ .TeamID }}</td>

          <td class="right actions">
            <button class="btn btn-small" type="button" onclick="openTask('{{ .TaskID }}')">
              Open
            </button>

            <select class="select select-small"
              onchange="changeStatus('{{ .TaskID }}', this.value)">
              <option value="TODO" {{ if eq .Status "TODO" }}selected{{ end }}>TODO</option>
              <option value="IN_PROGRESS" {{ if eq .Status "IN_PROGRESS" }}selected{{ end }}>IN_PROGRESS</option>
              <option value="DONE" {{ if eq .Status "DONE" }}selected{{ end }}>DONE</option>
            </select>
          </td>
        </tr>
        {{ end }}
      </tbody>
    </table>
  </div>
  {{ else }}
    <p class="muted">No tasks assigned to you.</p>
  {{ end }}

  {{/* DETAILS MODAL */}}
  <dialog id="taskDetailModal">
    <div class="modal">
      <div class="modal-head">
        <div>
          <h3 id="tdTitle">Task</h3>
          <p class="modal-sub" id="tdMeta"></p>
        </div>
        <button class="btn btn-secondary btn-small" type="button"
          onclick="document.getElementById('taskDetailModal').close()">
          Close
        </button>
      </div>

      <div class="kv">
        <div><b>Status:</b> <span id="tdStatus"></span></div>
        <div><b>Assignee:</b> <span id="tdAssignee"></span></div>
        <div><b>Author:</b> <span id="tdAuthor"></span></div>
        <div><b>Deadline:</b> <span id="tdDeadline"></span></div>
        <div><b>Priority:</b> <span id="tdPriority"></span></div>
      </div>

      <hr/>

      <h4>Description</h4>
      <p class="muted" id="tdDesc"></p>

      <hr/>

      <h4>Comments</h4>
      <ul id="tdComments" class="list-tight"></ul>

      <hr/>

      <h4>Add comment</h4>
      <form onsubmit="return submitComment(event)">
        <input type="hidden" id="tdTaskID" />
        <textarea id="tdCommentBody" name="body" maxlength="2000" required
                  placeholder="Write a comment..." style="width:100%; min-height:80px;"></textarea>
        <div class="row right" style="margin-top:0.5rem;">
          <button class="btn btn-small positive-btn" type="submit">Post</button>
        </div>
      </form>

    </div>
  </dialog>

  {{/* CREATE TASK MODAL (leader/admin) */}}
  {{ if .VM.CanCreate }}
  <dialog id="createTaskModal">
    <form method="post" action="/api/v1/auth/leader/tasks/create" class="modal">
      <h3>Create task</h3>

      <label>Team ID</label>
      <input name="teamid" required />

      <label>Title</label>
      <input name="title" required maxlength="120"/>

      <label>Description</label>
      <textarea name="description" maxlength="2000"></textarea>

      <label>Assignee (username)</label>
      <input name="assignee" required maxlength="80"/>

      <label>Priority</label>
      <select name="priority">
        <option value="LOW">LOW</option>
        <option value="MEDIUM" selected>MEDIUM</option>
        <option value="HIGH">HIGH</option>
      </select>

      <label>Deadline</label>
      <input type="date" name="deadline"/>

      <div class="row right">
        <button class="btn positive-btn" type="submit">Create</button>
        <button class="btn btn-secondary" type="button"
          onclick="document.getElementById('createTaskModal').close()">
          Cancel
        </button>
      </div>
    </form>
  </dialog>
  {{ end }}

  <script>
    async function openTask(taskID) {
      try {
        const res = await fetch(`/api/v1/auth/tasks/${taskID}/json`, {
          headers: { "Accept": "application/json" }
        });
        if (!res.ok) {
          alert("Failed to load task: " + await res.text());
          return;
        }
        const data = await res.json();
        const t = data.task;
        const comments = data.comments || [];

        document.getElementById('tdTitle').textContent = t.title || 'Task';
        document.getElementById('tdMeta').textContent = `Task #${t.taskid} · Team ${t.teamid}`;
        document.getElementById('tdStatus').textContent = t.status || '-';
        document.getElementById('tdAssignee').textContent = t.assignee || '-';
        document.getElementById('tdAuthor').textContent = t.author || '-';
        document.getElementById('tdPriority').textContent = t.priority || '-';
        document.getElementById('tdDeadline').textContent = t.deadline ? String(t.deadline).slice(0,10) : '-';
        document.getElementById('tdDesc').textContent = t.description || '-';
        document.getElementById('tdTaskID').value = t.taskid;

        const ul = document.getElementById('tdComments');
        ul.innerHTML = '';
        if (comments.length === 0) {
          const li = document.createElement('li');
          li.textContent = 'No comments';
          ul.appendChild(li);
        } else {
          comments.forEach(c => {
            const li = document.createElement('li');
            li.textContent = `${c.author}: ${c.body}`;
            ul.appendChild(li);
          });
        }

        document.getElementById('taskDetailModal').showModal();
      } catch (e) {
        alert("Failed to load task: " + e);
      }
    }

    async function changeStatus(taskID, status) {
      try {
        const res = await fetch(`/api/v1/auth/tasks/${taskID}/status`, {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            "Accept": "application/json"
          },
          body: new URLSearchParams({ status })
        });
        if (!res.ok) {
          alert("Status update failed: " + await res.text());
          return;
        }
        const s = document.getElementById(`task-status-${taskID}`);
        if (s) s.textContent = status;
      } catch (e) {
        alert("Status update failed: " + e);
      }
    }

    async function submitComment(ev) {
  ev.preventDefault();

  const taskID = document.getElementById('tdTaskID').value;
  const bodyEl = document.getElementById('tdCommentBody');
  const body = bodyEl.value.trim();
  if (!body) return false;

  try {
    const res = await fetch(`/api/v1/auth/tasks/${taskID}/comment`, {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded",
        "Accept": "application/json"
      },
      body: new URLSearchParams({ body })
    });

    if (!res.ok) {
      alert("Failed to add comment: " + await res.text());
      return false;
    }

    // Append new comment at end (or top, your choice)
    const ul = document.getElementById('tdComments');
    // if it currently says "No comments", clear it
    if (ul.children.length === 1 && ul.children[0].textContent === "No comments") {
      ul.innerHTML = "";
    }

    const li = document.createElement('li');
    li.textContent = `You: ${body}`;
    ul.appendChild(li);

    bodyEl.value = "";
    return false;
  } catch (e) {
    alert("Failed to add comment: " + e);
    return false;
  }
}

  </script>

</section>
{{ template "partials/task_modal.html" . }}
{{ end }}


